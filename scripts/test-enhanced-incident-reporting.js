#!/usr/bin/env node
/**
 * Enhanced Incident Reporting System Test
 * 
 * This script tests the enhanced rollback incident reporting system
 * with GitHub integration and @copilot assignment functionality.
 */

import { promises as fs } from 'fs';
import { join } from 'path';
import { IncidentReporter } from '../src/cli/simple-commands/init/rollback/incident-reporter.js';

async function testEnhancedIncidentReporting() {
  console.log('ğŸ§ª Testing Enhanced Rollback Incident Reporting System');
  console.log('===================================================\n');

  try {
    // Test 1: Basic incident report generation
    console.log('1ï¸âƒ£ Testing basic incident report generation...');
    
    const tempDir = join(process.cwd(), 'test-incidents-enhanced');
    await fs.mkdir(tempDir, { recursive: true });
    
    const incidentReporter = new IncidentReporter(tempDir);
    
    const testData = {
      sessionId: 'test-enhanced-rollback-001',
      incidentType: 'Automated Rollback',
      severity: 'High',
      reason: 'CI pipeline failure requiring immediate rollback',
      sourceCommit: 'abc123def456',
      targetCommit: 'def456abc123',
      components: ['Claude Flow Core', 'CLI Interface', 'GitHub Integration'],
      userImpact: 'All users potentially affected',
      duration: '5 minutes (estimated)'
    };

    // Validate data first
    console.log('ğŸ“‹ Validating incident data...');
    const validation = incidentReporter.validateIncidentData(testData);
    
    if (!validation.isValid) {
      console.log('âŒ Validation failed:');
      validation.errors.forEach(error => console.log(`  - ${error}`));
      return;
    }
    
    if (validation.warnings.length > 0) {
      console.log('âš ï¸ Validation warnings:');
      validation.warnings.forEach(warning => console.log(`  - ${warning}`));
    }

    console.log('âœ… Incident data validation passed');

    // Test 2: Generate report with GitHub integration
    console.log('\n2ï¸âƒ£ Testing enhanced report generation...');
    
    const options = {
      createGitHubIssue: process.env.GITHUB_TOKEN || process.env.CI ? true : false, // Only create issue if token available
      assignees: ['copilot'],
      labels: ['rollback', 'incident', 'high-priority', 'automated'],
      notes: 'This is a test incident report generated by the enhanced incident reporting system.'
    };

    const result = await incidentReporter.generateRollbackIncidentReport(testData, options);
    
    if (result.success) {
      console.log(`âœ… Enhanced incident report generated: ${result.reportFile}`);
      console.log(`ğŸ“‹ Session ID: ${result.reportId}`);
      
      if (result.issueUrl) {
        console.log(`ğŸ¯ GitHub issue created: ${result.issueUrl}`);
        console.log(`ğŸ‘¤ Assigned to @copilot automatically`);
      } else if (result.warnings.length > 0) {
        console.log('âš ï¸ GitHub issue creation warnings:');
        result.warnings.forEach(warning => console.log(`  - ${warning}`));
      }
    } else {
      console.log('âŒ Failed to generate enhanced incident report');
      console.log('Errors:', result.errors);
    }

    // Test 3: Verify report content
    console.log('\n3ï¸âƒ£ Testing report content verification...');
    
    if (result.success && result.reportId) {
      const reportData = await incidentReporter.getIncidentReport(result.reportId);
      
      if (reportData.success) {
        console.log('âœ… Report content verification passed');
        
        // Check for key sections
        const content = reportData.report;
        const requiredSections = [
          '## ğŸ”„ Rollback Incident Details',
          '### Incident Summary',
          '### Rollback Information',
          '### Impact Assessment',
          '### Timeline',
          '### Root Cause Analysis',
          '### Resolution Actions',
          '### Prevention Measures',
          '### Lessons Learned',
          '### Follow-up Actions',
          '### Stakeholder Communication'
        ];

        const missingSections = requiredSections.filter(section => !content.includes(section));
        
        if (missingSections.length === 0) {
          console.log('âœ… All required template sections present');
        } else {
          console.log('âš ï¸ Missing template sections:');
          missingSections.forEach(section => console.log(`  - ${section}`));
        }

        // Verify @copilot assignment in metadata
        if (reportData.metadata && reportData.metadata.severity === 'High') {
          console.log('âœ… High-severity incident properly flagged');
        }

      } else {
        console.log('âŒ Failed to verify report content');
      }
    }

    // Test 4: List all incident reports
    console.log('\n4ï¸âƒ£ Testing incident report listing...');
    
    const listResult = await incidentReporter.listIncidentReports();
    if (listResult.success) {
      console.log(`âœ… Found ${listResult.reports.length} incident reports`);
      listResult.reports.forEach(report => {
        console.log(`  - ${report.id} (${report.severity}) - ${report.timestamp}`);
      });
    } else {
      console.log('âŒ Failed to list incident reports');
    }

    // Test 5: GitHub issue creation (if environment supports it)
    if (process.env.GITHUB_TOKEN) {
      console.log('\n5ï¸âƒ£ Testing direct GitHub issue creation...');
      
      const issueResult = await incidentReporter.createGitHubIssue(result.reportId, {
        owner: 'g2goose',
        repo: 'claude-flow',
        assignees: ['copilot'],
        labels: ['rollback', 'incident', 'test', 'high-priority']
      });

      if (issueResult.success) {
        console.log(`âœ… GitHub issue created: ${issueResult.issueUrl}`);
        console.log(`ğŸ“‹ Issue #${issueResult.issueNumber} assigned to @copilot`);
      } else {
        console.log('âŒ GitHub issue creation failed');
        console.log('Errors:', issueResult.errors);
      }
    } else {
      console.log('\n5ï¸âƒ£ Skipping GitHub issue creation (no GITHUB_TOKEN)');
    }

    // Summary
    console.log('\nğŸ“Š Test Summary');
    console.log('===============');
    console.log('âœ… Enhanced incident reporting system tests completed');
    console.log(`ğŸ“ Test reports stored in: ${tempDir}`);
    
    if (result.issueUrl) {
      console.log(`ğŸ¯ GitHub integration working: ${result.issueUrl}`);
    } else {
      console.log('ğŸ”§ GitHub integration requires GITHUB_TOKEN environment variable');
    }

    console.log('\nğŸ‰ All enhanced incident reporting features validated!');

    // Cleanup option
    if (!process.env.KEEP_TEST_DATA) {
      console.log('\nğŸ§¹ Cleaning up test data...');
      await fs.rm(tempDir, { recursive: true, force: true });
      console.log('âœ… Test cleanup completed');
    } else {
      console.log(`\nğŸ“ Test data preserved at: ${tempDir}`);
    }

  } catch (error) {
    console.error('ğŸ’¥ Test failed:', error.message);
    console.error('Stack trace:', error.stack);
    process.exit(1);
  }
}

// Run the test
testEnhancedIncidentReporting();